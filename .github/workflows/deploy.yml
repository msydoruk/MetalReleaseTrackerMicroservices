name: Deploy

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        type: choice
        options:
          - all
          - shared-infrastructure
          - parser-service
          - catalog-sync-service
          - core-data-service
          - frontend

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  DEPLOY_DIR: /home/ubuntu/metaltracker
  SSH_OPTS: -o StrictHostKeyChecking=no -o ServerAliveInterval=15 -o ServerAliveCountMax=20

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: inputs.service == 'parser-service' || inputs.service == 'all'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build ParserService
        run: dotnet build src/MetalReleaseTracker.ParserService --configuration Release

      - name: Run smoke tests
        run: dotnet test src/MetalReleaseTracker.ParserService --configuration Release --filter "Category=Smoke" --logger "console;verbosity=detailed"

  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [smoke-tests]
    if: always() && (needs.smoke-tests.result == 'success' || needs.smoke-tests.result == 'skipped')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Sync files to server
        run: |
          rsync -avz --delete \
            -e "ssh ${{ env.SSH_OPTS }} -i ~/.ssh/deploy_key" \
            --include='src/MetalReleaseTracker.SharedInfrastructure/***' \
            --include='src/MetalReleaseTracker.ParserService/***' \
            --include='src/MetalReleaseTracker.CatalogSyncService/***' \
            --include='src/MetalReleaseTracker.CoreDataService/***' \
            --include='src/MetalReleaseTracker.Frontend/***' \
            --include='src/MetalReleaseTracker.SharedLibraries/***' \
            --include='src/MetalReleaseTracker.sln' \
            --include='src/' \
            --exclude='*' \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.DEPLOY_DIR }}/

      - name: Write .env files
        run: |
          ssh ${{ env.SSH_OPTS }} -i ~/.ssh/deploy_key \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'SCRIPT'
          echo '${{ secrets.ENV_SHARED_INFRA }}' > ${{ env.DEPLOY_DIR }}/src/MetalReleaseTracker.SharedInfrastructure/.env
          echo '${{ secrets.ENV_PARSER_SERVICE }}' > ${{ env.DEPLOY_DIR }}/src/MetalReleaseTracker.ParserService/.env
          echo '${{ secrets.ENV_CATALOG_SYNC }}' > ${{ env.DEPLOY_DIR }}/src/MetalReleaseTracker.CatalogSyncService/.env
          echo '${{ secrets.ENV_CORE_DATA }}' > ${{ env.DEPLOY_DIR }}/src/MetalReleaseTracker.CoreDataService/.env
          SCRIPT

      - name: Pre-deploy cleanup
        run: |
          ssh ${{ env.SSH_OPTS }} -i ~/.ssh/deploy_key \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'SCRIPT'
          docker image prune -f
          docker builder prune -f
          echo "Cleaned dangling images and build cache"
          df -h / | tail -1
          SCRIPT

      - name: Deploy shared-infrastructure
        if: inputs.service == 'shared-infrastructure' || inputs.service == 'all'
        run: |
          ssh ${{ env.SSH_OPTS }} -i ~/.ssh/deploy_key \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'SCRIPT'
          set -e
          cd ${{ env.DEPLOY_DIR }}/src/MetalReleaseTracker.SharedInfrastructure
          docker compose up -d
          echo "Waiting for services to be healthy..."
          sleep 15
          docker compose ps
          SCRIPT

      - name: Deploy parser-service
        if: inputs.service == 'parser-service' || inputs.service == 'all'
        run: |
          ssh ${{ env.SSH_OPTS }} -i ~/.ssh/deploy_key \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'SCRIPT'
          set -e
          cd ${{ env.DEPLOY_DIR }}/src/MetalReleaseTracker.ParserService
          docker compose up -d --build
          echo "Waiting for services to start..."
          sleep 10
          docker compose ps
          SCRIPT

      - name: Deploy catalog-sync-service
        if: inputs.service == 'catalog-sync-service' || inputs.service == 'all'
        run: |
          ssh ${{ env.SSH_OPTS }} -i ~/.ssh/deploy_key \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'SCRIPT'
          set -e
          cd ${{ env.DEPLOY_DIR }}/src/MetalReleaseTracker.CatalogSyncService
          docker compose up -d --build
          echo "Waiting for services to start..."
          sleep 10
          docker compose ps
          SCRIPT

      - name: Deploy core-data-service
        if: inputs.service == 'core-data-service' || inputs.service == 'all'
        run: |
          ssh ${{ env.SSH_OPTS }} -i ~/.ssh/deploy_key \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'SCRIPT'
          set -e
          cd ${{ env.DEPLOY_DIR }}/src/MetalReleaseTracker.CoreDataService
          docker compose up -d --build
          echo "Waiting for services to start..."
          sleep 10
          docker compose ps
          SCRIPT

      - name: Deploy frontend
        if: inputs.service == 'frontend' || inputs.service == 'all'
        run: |
          ssh ${{ env.SSH_OPTS }} -i ~/.ssh/deploy_key \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'SCRIPT'
          set -e
          DEPLOY=${{ env.DEPLOY_DIR }}/src

          echo "Stopping .NET services to free memory for frontend build..."
          cd $DEPLOY/MetalReleaseTracker.ParserService && docker compose stop parser-service || true
          cd $DEPLOY/MetalReleaseTracker.CatalogSyncService && docker compose stop catalogsync-service || true
          cd $DEPLOY/MetalReleaseTracker.CoreDataService && docker compose stop coredata-service || true

          cd $DEPLOY/MetalReleaseTracker.Frontend
          docker compose up -d --build
          echo "Frontend built and started"

          echo "Restarting .NET services..."
          cd $DEPLOY/MetalReleaseTracker.ParserService && docker compose start parser-service
          cd $DEPLOY/MetalReleaseTracker.CatalogSyncService && docker compose start catalogsync-service
          cd $DEPLOY/MetalReleaseTracker.CoreDataService && docker compose start coredata-service

          cd $DEPLOY/MetalReleaseTracker.Frontend
          docker compose ps
          SCRIPT

      - name: Post-deploy cleanup
        if: always()
        run: |
          ssh ${{ env.SSH_OPTS }} -i ~/.ssh/deploy_key \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'SCRIPT'
          docker image prune -f
          docker builder prune -f
          echo ""
          echo "=== All containers ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "=== Disk usage ==="
          df -h /
          SCRIPT

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
